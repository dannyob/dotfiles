###
# macOS-specific configuration
###

# Homebrew
eval "$(/opt/homebrew/bin/brew shellenv)"
if type brew &>/dev/null; then
  FPATH=$(brew --prefix)/share/zsh/site-functions:$FPATH
fi

# GNU ls via homebrew (gls)
alias ls='gls -A -F --color=auto --hyperlink'

# macOS clipboard
alias clipin='pbcopy'
alias clipout='pbpaste'

###
# Guile (Homebrew)
###
export GUILE_LOAD_PATH=$GUILE_LOAD_PATH:/usr/local/share/guile/site/3.0/:/opt/homebrew/share/guile/site/3.0/
export GUILE_LOAD_COMPILED_PATH=$GUILE_LOAD_COMPILED_PATH:/usr/local/lib/guile/3.0/site-ccache/:/opt/homebrew/share/guile/site/3.0/site-ccache
export GUILE_SYSTEM_EXTENSIONS_PATH=$GUILE_SYSTEM_EXTENSIONS_PATH:/usr/local/lib/guile/3.0/extensions:/opt/homebrew/lib/guile/3.0/extensions

###
# NVM
###
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

###
# Mac-specific functions
###

# Recent browser history (Brave)
function dob-st {
  ( cd "/Users/danny/Library/Application Support/BraveSoftware/Brave-Browser/Default"
    sqlite3 'file:History?immutable=1' <<SQL
      select '* [' || title || '](' || url || ')'
        from urls
        order by last_visit_time desc
        limit 10;
SQL
  )
}

# Get URL of current Brave tab as markdown link
function dob-toplink {
  local url=$(osascript -e 'tell application "Brave" to return URL of active tab of front window')
  local title=$(osascript -e 'tell application "Brave" to return title of active tab of front window')
  echo "[$title]($url)"
}

# Update llm and reinstall plugins after homebrew upgrade
function dob-update-llm-plugins {
    echo "Getting current plugins..."
    local plugins=$(llm plugins | jq -r '.[].name')

    echo "Updating llm..."
    brew upgrade llm

    echo "Reinstalling plugins..."
    echo $plugins | while read plugin; do
        echo "Installing $plugin..."
        llm install -U $plugin
    done

    echo "Done! Current plugins:"
    llm plugins
}

# Launch Chrome with remote debugging
dob-chrome-rdp() {
  /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222 --user-data-dir=$HOME/Private/rdp-chrome/
}

alias acorn='open -a Acorn'

###
# Tailscale
###
[[ -f "/Applications/Tailscale.app/Contents/MacOS/Tailscale" ]] && alias tailscale="/Applications/Tailscale.app/Contents/MacOS/Tailscale"
